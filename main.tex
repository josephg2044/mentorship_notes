% \input{./preamble.tex}
\begin{document}

\section{Module 8 Lecture 1: First-Order Perturbation Theory and the
Feynman-Hellman Theorem}
All problems in quantum mechanics cannot be solved exactly, and thus
we need approximation methods, such as the variational method and
perturbation theory.

\subsection{Example: Simple Harmonic Oscillator}
We perturb the spring constant of the Simple Harmonic Oscillator
(SHO) by $\delta$.

\begin{definition}
  The perturbed Hamiltonian for a Simple Harmonic Oscillator with a
  perturbed spring constant is given by:
  \begin{equation} \label{eq:sho_perturbed_H}
    \hat H(\delta) = \frac{\hat p^2 }{2m} + \frac{1}{2}k(1+\delta)\hat x^2
  \end{equation}
  where the unperturbed Hamiltonian is $\hat H(0) = \frac{\hat p^2
  }{2m} + \frac{1}{2}k\hat x^2$.
\end{definition}

We know the exact energy to be:
\begin{align} \label{eq:sho_exact_energy_taylor}
  E_n(\delta) &= \hbar \omega \sqrt{1+\delta} \left(n+\frac{1}{2}\right) \\
  &= E_n(0)\left(1 + \frac{1}{2}\delta - \frac{1}{8}\delta^2 +
  \frac{1}{16}\delta^3 + \cdots\right) \notag \\
  &\text{with } \omega=\sqrt{\frac{k}{m}} \notag
\end{align}
We claim that the first order term of this expansion,
$\frac{1}{2}\delta$, can be calculated using the variational method.
This is computed with respect to the eigenstates of the unperturbed $\hat H$.

\begin{example}
  Applying the variational method to find the first-order
  correction for the SHO:
  \begin{align} \label{eq:sho_variational_first_order}
    E_n(\delta) &\approx \bra {\psi_n^0}\hat H (\delta) \ket{\psi_n^0} \\
    &=\bra {\psi_n^0}\hat H (0) + \frac{1}{2}k\delta\hat
    x^2\ket{\psi_n^0} \notag \\
    &=E_n(0) + \delta \bra{\psi_n^0}\frac{1}{2}k\hat
    x^2\ket{\psi_n^0} \notag
  \end{align}
  By the Virial theorem, for a harmonic oscillator,
  $\expectationvalue{\hat K} = \expectationvalue{\hat V} =
  \frac{1}{2}E$. So, $\bra{\psi_n^0}\frac{1}{2}k\hat
  x^2\ket{\psi_n^0} = \frac{1}{2}E_n(0)$. Thus, using the
  variational method, we have:
  \begin{equation}
    E_n(\delta) \approx E_n(0)\left( 1 + \frac{\delta}{2}\right)
  \end{equation}
  This result agrees with the first-order term in the Taylor series
  expansion shown in \eqref{eq:sho_exact_energy_taylor}.
\end{example}

\hr
\subsection{Feynman-Hellman Theorem}
We aim to compute the derivative of an energy with respect to some
parameter $\lambda$.

\begin{theorem}[Feynman-Hellman Theorem]
  Given a Hamiltonian $\hat H(\lambda)$ that depends on a parameter
  $\lambda$, and its corresponding normalized eigenstate
  $\ket{\psi(\lambda)}$ with eigenvalue $E(\lambda)$, the
  derivative of the energy with respect to $\lambda$ is given by:
  \begin{equation} \label{eq:feynman_hellman_theorem}
    \dv{E(\lambda)}{\lambda} = \bra{\psi(\lambda)} \dv{\hat
    H(\lambda)}{\lambda} \ket{\psi(\lambda)}
  \end{equation}
\end{theorem}

\begin{proof}
  We start with the time-independent Schrödinger equation and the
  normalization condition:
  \begin{align} \label{eq:schrodinger_normalization}
    \hat H(\lambda)\ket{\psi(\lambda)} = E(\lambda)\ket{\psi(\lambda)} \\
    \bra{\psi(\lambda)}\ket{\psi(\lambda)} = 1 \notag
  \end{align}
  We want to compute $\dv{E(\lambda)}{\lambda}$. We can express
  $E(\lambda)$ as the expectation value of $\hat H(\lambda)$:
  \begin{equation}
    E(\lambda) = \bra{\psi(\lambda)}\hat H(\lambda)\ket{\psi(\lambda)}
  \end{equation}
  Now, we take the derivative with respect to $\lambda$:
  \begin{align} \label{eq:feynman_hellman_derivation_step1}
    \dv{E(\lambda)}{\lambda} &=
    \dv{\lambda}\bra{\psi(\lambda)}\hat H(\lambda)\ket{\psi(\lambda)} \\
    &= \left(\dv{\lambda} \bra{\psi(\lambda)}\right)\hat
    H(\lambda)\ket{\psi(\lambda)} + \bra{\psi(\lambda)} \dv{\hat
    H(\lambda)}{\lambda} \ket{\psi(\lambda)} +
    \bra{\psi(\lambda)}\hat H(\lambda)\ \left(\dv{\lambda}
    \ket{\psi(\lambda)}\right) \notag
  \end{align}
  In the first and third terms, we can substitute $\hat
  H(\lambda)\ket{\psi(\lambda)} = E(\lambda)\ket{\psi(\lambda)}$
  and $\bra{\psi(\lambda)}\hat H(\lambda) = E(\lambda)\bra{\psi(\lambda)}$:
  \begin{align} \label{eq:feynman_hellman_derivation_step2}
    &= \left(\dv{\lambda} \bra{\psi(\lambda)}\right) E(\lambda)
    \ket{\psi(\lambda)} + \bra{\psi(\lambda)} \dv{\hat
    H(\lambda)}{\lambda} \ket{\psi(\lambda)} +
    \bra{\psi(\lambda)} E(\lambda) \left(\dv{\lambda}
    \ket{\psi(\lambda)}\right) \\
    &= \bra{\psi(\lambda)} \dv{\hat H(\lambda)}{\lambda}
    \ket{\psi(\lambda)} + E(\lambda) \left(\left(\dv{\lambda}
      \bra{\psi(\lambda)}\right) \ket{\psi(\lambda)} +
      \bra{\psi(\lambda)} \left(\dv{\lambda}
    \ket{\psi(\lambda)}\right) \right) \notag
  \end{align}
  The terms inside the parenthesis for $E(\lambda)$ can be
  recognized as the derivative of the normalization condition:
  \begin{equation} \label{eq:feynman_hellman_normalization_deriv}
    \dv{\lambda}
    \left(\bra{\psi(\lambda)}\ket{\psi(\lambda)}\right) =
    \left(\dv{\lambda} \bra{\psi(\lambda)}\right)
    \ket{\psi(\lambda)} + \bra{\psi(\lambda)} \left(\dv{\lambda}
    \ket{\psi(\lambda)}\right)
  \end{equation}
  Since $\bra{\psi(\lambda)}\ket{\psi(\lambda)} = 1$, its
  derivative with respect to $\lambda$ is $0$.
  \begin{align} \label{eq:feynman_hellman_derivation_final}
    &= \bra{\psi(\lambda)} \dv{\hat H(\lambda)}{\lambda}
    \ket{\psi(\lambda)} + E(\lambda) \left(\dv{\lambda} 1\right) \\
    &= \bra{\psi(\lambda)} \dv{\hat H(\lambda)}{\lambda}
    \ket{\psi(\lambda)} + E(\lambda) \cdot 0 \notag \\
    &= \bra{\psi(\lambda)} \dv{\hat H(\lambda)}{\lambda}
    \ket{\psi(\lambda)} \notag
  \end{align}
  This completes the proof.
\end{proof}

\begin{example}
  Using the Feynman-Hellman equation, we can show that the
  variational form of the first-order energy correction is
  equivalent to the first-order Taylor expansion derived earlier.
  Let $\hat H(\delta) = \hat H(0) + \delta\hat V$. Then
  $E_n(\delta)$ can be expanded as a Taylor series around $\delta=0$:
  \begin{align} \label{eq:taylor_expansion_feynman_hellman}
    E_n(\delta) &\approx E_n(0) + \delta
    \left.\dv{E_n(\delta)}{\delta} \right|_{\delta =0} \\
    &= E_n(0) + \delta \bra{\psi_n^0} \left.\dv{\hat
    H(\delta)}{\delta}\right|_{\delta=0} \ket{\psi_n^0} \notag \\
    &= E_n(0) + \delta \bra{\psi_n^0} \dv{\delta}\left(\hat H(0)
    + \delta\hat V\right) \ket{\psi_n^0} \notag \\
    &= E_n(0) + \delta \bra{\psi_n^0} \hat V\ket{\psi_n^0} \notag
  \end{align}
  This result, $E_n(0) + \delta \bra{\psi_n^0} \hat
  V\ket{\psi_n^0}$, is precisely the first-order energy correction
  from perturbation theory, which we saw earlier also matched the
  variational method's result for the SHO.
\end{example}

\hr
\subsection{Application: Hyperfine Structure of Hydrogen}

\hr
\subsection{Application: Calculating $\bra{n, l}\frac{1}{\hat
r^2}\ket{n, l}$ by Feynman-Hellman}

\begin{problem}
  For hydrogen, the radial Hamiltonian is given by:
  \begin{equation} \label{eq:hydrogen_H_l}
    \hat H_l = \frac{\hat p_r^2}{2M} + \frac{\hbar^2
    l(l+1)}{2M\hat r^2} - \frac{e^2}{\hat r}
  \end{equation}
  and $\hat H_l \ket{n,l} = E_n \ket{n, l}$. We are also given the
  energy for the $m$-th excited state for a generalized parameter $\lambda$:
  \begin{equation} \label{eq:hydrogen_E_m_lambda}
    E_m(\lambda) = -\frac{e^2}{2a_0(m+\lambda+1)^2}
  \end{equation}
  Calculate the expectation value $\bra{n, l}\frac{1}{\hat
  r^2}\ket{n, l}$ using the Feynman-Hellman Theorem.
\end{problem}

\begin{solution}
  We generalize the Hamiltonian by replacing $l$ with a continuous
  parameter $\lambda$:
  \begin{equation} \label{eq:hydrogen_H_lambda}
    \hat H(\lambda) = \frac{\hat p_r^2}{2M} + \frac{\hbar^2
    \lambda(\lambda+1)}{2M\hat r^2} - \frac{e^2}{\hat r}
  \end{equation}
  Although $l$ is an integer, making derivatives with respect to
  $l$ seem invalid, the Feynman-Hellman theorem still applies by
  considering $\lambda$ as a formal continuous parameter for the
  purpose of differentiation, and then setting $\lambda=l$ at the end.

  Applying the Feynman-Hellman theorem:
  \begin{align} \label{eq:hydrogen_feynman_hellman_derivation}
    \dv{E_m(\lambda)}{\lambda} &= \bra{n,l}\dv{\hat
    H(\lambda)}{\lambda}\ket{n,l} \\
    \dv{\lambda}\left(-\frac{e^2}{2a_0(m+\lambda+1)^2}\right) &=
    \bra{n,l} \dv{\lambda}\left(\frac{\hat p_r^2}{2M} +
      \frac{\hbar^2 \lambda(\lambda+1)}{2M\hat r^2} -
    \frac{e^2}{\hat r}\right) \ket{n,l} \notag \\
    -\frac{e^2}{2a_0}(-2)(m+\lambda+1)^{-3}(1) &= \bra{n,l}
    \frac{\hbar^2(2\lambda + 1)}{2M \hat r^2} \ket{n,l} \notag \\
    \frac{e^2}{a_0(m+\lambda+1)^3} &= \bra{n,l}
    \frac{\hbar^2(2\lambda + 1)}{2M \hat r^2} \ket{n,l} \notag
  \end{align}
  Now we set $m+\lambda+1 = n$ (where $n$ is the principal quantum
    number for hydrogen, $n = l+1, l+2, \dots$ and also $\lambda =
  l$) and substitute into the equation:
  \begin{align}
    \frac{e^2}{a_0 n^3} &= \bra{n,l} \frac{\hbar^2(2l + 1)}{2M
    \hat r^2} \ket{n,l} \\
    \frac{e^2}{a_0 n^3} &= \frac{\hbar^2(2l + 1)}{2M} \bra{n,l}
    \frac{1}{\hat r^2} \ket{n,l} \notag
  \end{align}
  Recalling that the Bohr radius $a_0 = \frac{\hbar^2}{Me^2}$, we
  can substitute $M = \frac{\hbar^2}{a_0 e^2}$:
  \begin{align}
    \frac{e^2}{a_0 n^3} &= \frac{\hbar^2(2l +
    1)}{2(\frac{\hbar^2}{a_0 e^2}) \hat r^2} \bra{n,l}
    \frac{1}{\hat r^2} \ket{n,l} \notag \\
    \frac{e^2}{a_0 n^3} &= \frac{a_0 e^2 (2l + 1)}{2} \bra{n,l}
    \frac{1}{\hat r^2} \ket{n,l} \notag
  \end{align}
  Solving for $\bra{n,l} \frac{1}{\hat r^2} \ket{n,l}$:
  \begin{equation} \label{eq:r_minus_2_expectation_value}
    \boxed{\bra{n,l} \frac{1}{\hat r^2} \ket{n,l} =
    \frac{1}{a_0^2 n^3(l + \frac{1}{2})}}
  \end{equation}
\end{solution}

\hr
\section{Module 8 Lecture 2: Second Order Perturbation Theory (via derivatives)}
There is a general formal technique to determine perturbation theory
to an arbitrary order. However, it is complicated so this lecture
only covers the second order-derivation.

\subsection{Derivation}
Using $\lambda$ as the small parameter, we write $\hat H(\lambda) =
\hat H_0 + \lambda \hat V$. The wavefunction is denoted
$\ket{\psi_n(\lambda)}$ and the energy $E_n(\lambda)$. We then
perform a Taylor series expansion on the energy:
\begin{equation} \label{eq:energy_taylor_expansion}
  E_n(\lambda) = E_n(0) + \lambda
  \left.\dv{E_n(\lambda)}{\lambda}\right|_{\lambda=0} +
  \frac{\lambda^2}{2}
  \left.\dv[2]{E_n(\lambda)}{\lambda}\right|_{\lambda=0} + \cdots
\end{equation}
We recall the basic properties:
\begin{equation} \label{eq:schrodinger_normalization_perturbed}
  E_n(0) = \bra{\psi_n} \hat H_0 \ket{\psi_n}, \quad\quad \hat
  H(\lambda)\ket{\psi_n(\lambda)} =
  E_n(\lambda)\ket{\psi_n(\lambda)}, \quad\quad
  \bra{\psi_n(\lambda)} \ket{\psi_n(\lambda)} = 1
\end{equation}
From the Feynman-Hellman theorem, we derived the first derivative:
\begin{equation} \label{eq:first_derivative_perturbation}
  \left.\dv{E_n(\lambda)}{\lambda}\right|_{\lambda=0} =
  \left.\bra{\psi_n}\dv{\hat
  H(\lambda)}{\lambda}\right|_{\lambda=0}\ket{\psi_n} =
  \bra{\psi_n}\hat V\ket{\psi_n} = V_{nn}
\end{equation}
We now aim to calculate the second derivative,
$\left.\dv[2]{E_n(\lambda)}{\lambda}\right|_{\lambda=0}$.

\begin{theorem}[Second-Order Perturbation Energy Correction]
  The second-order energy correction for a non-degenerate
  eigenvalue $E_n$ due to a perturbation $\lambda \hat V$ is given by:
  \begin{equation} \label{eq:second_order_energy_correction}
    E_n^{(2)} = \sum_{m \ne n} \frac{|\bra{\psi_m}\hat
    V\ket{\psi_n}|^2}{E_n^{(0)} - E_m^{(0)}}
  \end{equation}
  where $E_n^{(0)}$ and $\ket{\psi_n}$ are the unperturbed energy
  and wavefunction respectively.
\end{theorem}

\begin{proof}
  We start by differentiating the Feynman-Hellman result
  \eqref{eq:first_derivative_perturbation} with respect to $\lambda$:
  \begin{align} \label{eq:second_deriv_start}
    \left.\dv[2]{E_n(\lambda)}{\lambda}\right|_{\lambda=0} &=
    \dv{\lambda}\left(\bra{\psi_n(\lambda)} \dv{\hat
    H(\lambda)}{\lambda} \ket{\psi_n(\lambda)}\right)\bigg|_{\lambda=0} \\
    &= \left(\dv{\lambda}\bra{\psi_n(\lambda)}\right)
    \left(\dv{\hat H(\lambda)}{\lambda}\right)
    \ket{\psi_n(\lambda)} \bigg|_{\lambda=0} \notag \\
    &\quad + \bra{\psi_n(\lambda)} \left(\dv[2]{\hat
    H(\lambda)}{\lambda}\right) \ket{\psi_n(\lambda)}
    \bigg|_{\lambda=0} \notag \\
    &\quad + \bra{\psi_n(\lambda)} \left(\dv{\hat
    H(\lambda)}{\lambda}\right)
    \left(\dv{\lambda}\ket{\psi_n(\lambda)}\right) \bigg|_{\lambda=0} \notag
  \end{align}
  Since $\hat H(\lambda) = \hat H_0 + \lambda \hat V$, we have
  $\dv{\hat H(\lambda)}{\lambda} = \hat V$ and $\dv[2]{\hat
  H(\lambda)}{\lambda} = 0$. Evaluating at $\lambda=0$ and
  replacing $\ket{\psi_n(\lambda)}$ with $\ket{\psi_n}$, we get:
  \begin{align} \label{eq:second_deriv_intermediate}
    \left.\dv[2]{E_n(\lambda)}{\lambda}\right|_{\lambda=0} &=
    \left(\dv{\lambda}\bra{\psi_n(\lambda)}\right)_{\lambda=0}
    \hat V \ket{\psi_n} + \bra{\psi_n} \hat V
    \left(\dv{\lambda}\ket{\psi_n(\lambda)}\right)_{\lambda=0} \\
    &= 2 \re \left( \bra{\psi_n} \hat V
      \left(\dv{\lambda}\ket{\psi_n(\lambda)}\right)_{\lambda=0}
    \right) \notag
  \end{align}
  To compute
  $\left(\dv{\lambda}\ket{\psi_n(\lambda)}\right)_{\lambda=0}$, we
  differentiate the Schrödinger equation $\hat
  H(\lambda)\ket{\psi_n(\lambda)} =
  E_n(\lambda)\ket{\psi_n(\lambda)}$ with respect to $\lambda$:
  \begin{align} \label{eq:schrodinger_deriv}
    \dv{\hat H(\lambda)}{\lambda} \ket{\psi_n(\lambda)} + \hat
    H(\lambda) \dv{\lambda}\ket{\psi_n(\lambda)} &=
    \dv{E_n(\lambda)}{\lambda} \ket{\psi_n(\lambda)} +
    E_n(\lambda) \dv{\lambda}\ket{\psi_n(\lambda)}
  \end{align}
  At $\lambda=0$:
  \begin{align} \label{eq:schrodinger_deriv_at_zero}
    \hat V \ket{\psi_n} + \hat H_0
    \left(\dv{\lambda}\ket{\psi_n(\lambda)}\right)_{\lambda=0} &=
    V_{nn} \ket{\psi_n} + E_n(0)
    \left(\dv{\lambda}\ket{\psi_n(\lambda)}\right)_{\lambda=0}
  \end{align}
  Rearranging the terms, we get:
  \begin{equation} \label{eq:psi_deriv_equation}
    (\hat H_0 - E_n(0))
    \left(\dv{\lambda}\ket{\psi_n(\lambda)}\right)_{\lambda=0} =
    (V_{nn} - \hat V) \ket{\psi_n}
  \end{equation}
  Since $\ket{\psi_n(\lambda)}$ is normalized,
  $\bra{\psi_n(\lambda)}\ket{\psi_n(\lambda)} = 1$. Differentiating
  gives
  $\left(\dv{\lambda}\bra{\psi_n(\lambda)}\right)\ket{\psi_n(\lambda)}
  +
  \bra{\psi_n(\lambda)}\left(\dv{\lambda}\ket{\psi_n(\lambda)}\right)
  = 0$. At $\lambda=0$:
  \begin{equation} \label{eq:psi_deriv_orthogonality}
    \bra{\psi_n}
    \left(\dv{\lambda}\ket{\psi_n(\lambda)}\right)_{\lambda=0} +
    \left(\dv{\lambda}\bra{\psi_n(\lambda)}\right)_{\lambda=0}
    \ket{\psi_n} = 0
  \end{equation}
  This means
  $\left(\dv{\lambda}\ket{\psi_n(\lambda)}\right)_{\lambda=0}$ is
  orthogonal to $\ket{\psi_n}$. Let $\ket{\psi_n^{(1)}} =
  \left(\dv{\lambda}\ket{\psi_n(\lambda)}\right)_{\lambda=0}$.

  For non-degenerate energy eigenvalues, we can express
  $\ket{\psi_n^{(1)}}$ as a linear combination of other unperturbed
  eigenstates $\ket{\psi_m}$ (where $m \ne n$):
  \begin{equation}
    \ket{\psi_n^{(1)}} = \sum_{m \ne n} c_m \ket{\psi_m}
  \end{equation}
  Applying $\bra{\psi_k}$ (for $k \ne n$) to \eqref{eq:psi_deriv_equation}:
  \begin{align}
    \bra{\psi_k}(\hat H_0 - E_n(0)) \ket{\psi_n^{(1)}} &=
    \bra{\psi_k}(V_{nn} - \hat V) \ket{\psi_n} \\
    (E_k(0) - E_n(0)) \bra{\psi_k}\ket{\psi_n^{(1)}} &=
    \bra{\psi_k}V_{nn}\ket{\psi_n} - \bra{\psi_k}\hat
    V\ket{\psi_n} \notag \\
    (E_k(0) - E_n(0)) c_k &= V_{nn}\braket{\psi_k}{\psi_n} - V_{kn} \notag
  \end{align}
  Since $\braket{\psi_k}{\psi_n} = 0$ for $k \ne n$, this simplifies to:
  \begin{align} \label{eq:coefficient_c_k}
    (E_k(0) - E_n(0)) c_k &= -V_{kn} \\
    c_k &= \frac{V_{kn}}{E_n(0) - E_k(0)} \notag
  \end{align}
  So, the first-order correction to the wavefunction is:
  \begin{equation} \label{eq:psi_n_first_order_correction}
    \ket{\psi_n^{(1)}} = \sum_{m \ne n} \frac{V_{mn}}{E_n(0) -
    E_m(0)} \ket{\psi_m}
  \end{equation}
  Now substitute this back into \eqref{eq:second_deriv_intermediate}:
  \begin{align} \label{eq:second_deriv_final_step}
    \left.\dv[2]{E_n(\lambda)}{\lambda}\right|_{\lambda=0} &=
    \bra{\psi_n}\hat V \sum_{m \ne n} \frac{V_{mn}}{E_n(0) -
    E_m(0)} \ket{\psi_m} + \sum_{m \ne n} \frac{V_{nm}}{E_n(0) -
    E_m(0)} \bra{\psi_m} \hat V \ket{\psi_n} \\
    &= \sum_{m \ne n} \frac{V_{nm} V_{mn}}{E_n(0) - E_m(0)} +
    \sum_{m \ne n} \frac{V_{nm} V_{mn}}{E_n(0) - E_m(0)} \notag \\
    &= 2 \sum_{m \ne n} \frac{V_{nm} V_{mn}}{E_n(0) - E_m(0)} \notag \\
    &= 2 \sum_{m \ne n} \frac{|V_{mn}|^2}{E_n(0) - E_m(0)} \notag
  \end{align}
  Therefore, the second-order energy correction term in the Taylor
  expansion ($E_n^{(2)} = \frac{\lambda^2}{2}
  \left.\dv[2]{E_n(\lambda)}{\lambda}\right|_{\lambda=0}$) is:
  \begin{equation} \label{eq:final_second_order_energy_correction_formula}
    E_n^{(2)} = \frac{\lambda^2}{2} \left( 2 \sum_{m \ne n}
    \frac{|V_{mn}|^2}{E_n(0) - E_m(0)} \right) = \lambda^2
    \sum_{m \ne n} \frac{|V_{mn}|^2}{E_n(0) - E_m(0)}
  \end{equation}
  And the total energy up to second order is:
  \begin{equation}
    E_n(\lambda) = E_n^{(0)} + \lambda V_{nn} + \lambda^2 \sum_{m
    \ne n} \frac{|V_{mn}|^2}{E_n^{(0)} - E_m^{(0)}} + \cdots
  \end{equation}
  The wavefunction to first order is:
  \begin{align} \label{eq:wavefunction_first_order}
    \ket{\psi_n(\lambda)} &= \ket{\psi_n} + \lambda
    \left(\dv{\lambda}\ket{\psi_n(\lambda)}\right)_{\lambda=0} + \cdots \\
    &= \ket{\psi_n} + \lambda \sum_{m \ne n} \frac{V_{mn}}{E_n(0)
    - E_m(0)} \ket{\psi_m} + \cdots \notag
  \end{align}
\end{proof}

\hr
\subsection{Example: Simple Harmonic Oscillator}
\begin{example}
  We apply the second-order perturbation theory to the perturbed
  Hamiltonian operator from Section 1.1:
  \begin{equation} \label{eq:sho_perturbed_H_lambda_V}
    \hat H = \frac{\hat p^2 }{2m} + \frac{1}{2}k\hat x^2 +
    \lambda \left(\frac{1}{2} k \hat x^2\right)
  \end{equation}
  Here, the perturbation is $\hat V = \frac{1}{2}k \hat x^2$.

  First, calculate the first-order energy correction $V_{nn}$:
  \begin{equation} \label{eq:sho_v_nn}
    V_{nn} = \bra{n}\frac{1}{2}k \hat x^2\ket{n} = \frac{1}{2}
    \hbar \omega \left(n + \frac{1}{2}\right)
  \end{equation}
  So, the energy to first order is:
  \begin{equation} \label{eq:sho_energy_first_order}
    E_n (\lambda) = \hbar \omega \left (n + \frac{1}{2}\right) +
    \lambda \frac{1}{2} \hbar \omega \left(n + \frac{1}{2}\right) + \cdots
  \end{equation}
  Next, we need the matrix elements $V_{mn} = \bra{m}\hat V\ket{n}$:
  \begin{align} \label{eq:sho_v_mn}
    V_{mn} &= \bra{m}{\frac{1}{2}k \hat x^2}\ket{n} \\
    &= \frac{1}{2} m \omega^2 \frac{\hbar}{2m\omega} \bra{m}(\hat
    a + \hat a^\dagger)^2 \ket{n} \notag \\
    &= \frac{\hbar \omega}{4} \bra{m}\hat a^2 + \hat a \hat
    a^\dagger + \hat a^\dagger \hat a + (\hat a^\dagger)^2 \ket{n} \notag \\
    &= \frac{\hbar \omega}{4} \left( \sqrt{n(n-1)}\delta_{m, n-2}
    + (2n+1)\delta_{m,n} + \sqrt{(n+1)(n+2)}\delta_{m,n+2}\right) \notag
  \end{align}
  Note that the $\delta_{m,n}$ term corresponds to $V_{nn}$ and
  does not contribute to the second-order sum since $m \ne n$. The
  terms that contribute to the second-order sum are for $m=n-2$ and $m=n+2$.

  The second-order energy correction is $\lambda^2 \sum_{m \ne n}
  \frac{|V_{mn}|^2}{E_n(0) - E_m(0)}$.
  For $m=n-2$: $V_{n,n-2} = \frac{\hbar \omega}{4}\sqrt{n(n-1)}$.
  $E_n(0) - E_{n-2}(0) = \hbar\omega(n+\frac{1}{2}) -
  \hbar\omega(n-2+\frac{1}{2}) = 2\hbar\omega$.
  For $m=n+2$: $V_{n,n+2} = \frac{\hbar
  \omega}{4}\sqrt{(n+1)(n+2)}$. $E_n(0) - E_{n+2}(0) =
  \hbar\omega(n+\frac{1}{2}) - \hbar\omega(n+2+\frac{1}{2}) = -2\hbar\omega$.

  Substituting these into the second-order formula:
  \begin{align} \label{eq:sho_energy_second_order_full}
    E_n (\lambda) &= \hbar \omega \left (n + \frac{1}{2}\right) +
    \lambda \frac{1}{2} \hbar \omega \left(n + \frac{1}{2}\right)
    + \lambda^2 \left( \frac{|V_{n,n-2}|^2}{E_n(0) - E_{n-2}(0)}
    + \frac{|V_{n,n+2}|^2}{E_n(0) - E_{n+2}(0)} \right) + \cdots \\
    &= \hbar \omega \left (n + \frac{1}{2}\right) + \lambda
    \frac{1}{2} \hbar \omega \left(n + \frac{1}{2}\right) +
    \lambda^2 \left( \frac{\left(\frac{\hbar \omega}{4}\right)^2
      n(n-1)}{2\hbar\omega} + \frac{\left(\frac{\hbar
    \omega}{4}\right)^2 (n+1)(n+2)}{-2\hbar\omega}\right)+ \cdots \notag \\
    &= \hbar \omega \left (n + \frac{1}{2}\right) + \lambda
    \frac{1}{2} \hbar \omega \left(n + \frac{1}{2}\right) +
    \lambda^2 \frac{(\hbar \omega)^2}{16 \cdot 2\hbar\omega}
    \left( n(n-1) - (n+1)(n+2)\right)+ \cdots \notag \\
    &= \hbar \omega \left (n + \frac{1}{2}\right) + \lambda
    \frac{1}{2} \hbar \omega \left(n + \frac{1}{2}\right) +
    \lambda^2 \frac{\hbar \omega}{32} \left( n^2-n -
    (n^2+3n+2)\right)+ \cdots \notag \\
    &= \hbar \omega \left (n + \frac{1}{2}\right) + \lambda
    \frac{1}{2} \hbar \omega \left(n + \frac{1}{2}\right) +
    \lambda^2 \frac{\hbar \omega}{32} \left( -4n-2\right)+ \cdots \notag \\
    &= \hbar \omega \left (n + \frac{1}{2}\right) + \lambda
    \frac{1}{2} \hbar \omega \left(n + \frac{1}{2}\right) -
    \lambda^2 \frac{\hbar \omega}{16} \left(2n+1\right)+ \cdots \notag \\
    &= \hbar \omega \left (n + \frac{1}{2}\right) + \lambda
    \frac{1}{2} \hbar \omega \left(n + \frac{1}{2}\right) -
    \lambda^2 \frac{\hbar \omega}{8} \left(n +
    \frac{1}{2}\right)+ \cdots \notag \\
    &= \hbar\omega \left( n + \frac{1}{2}\right) \left(1 +
    \frac{\lambda}{2} - \frac{\lambda^2}{8} + \cdots\right) \notag
  \end{align}
  This result precisely matches the Taylor expansion of the exact
  energy $E_n(\delta) = \hbar\omega \left(n+\frac{1}{2}\right)
  \sqrt{1 + \lambda}$ from \eqref{eq:sho_exact_energy_taylor},
  confirming the validity of the perturbation theory derivation.
\end{example}

\hr
\section{Messiah Chapter XVI}
\subsection{§15 The Hamiltonian and its Resolvent}
\begin{note}
  A convenient way to organize stationary perturbation theory to
  all orders is to use the resolvent of the Hamiltonian. For a
  complex parameter $z$, the resolvent is defined as:
  \begin{equation} \label{eq:resolvent_definition}
    \hat G(z):=\frac{1}{z-\hat H}
  \end{equation}
  As a function of $z$, $\hat G(z)$ is analytic everywhere except
  when $z - \hat H = 0$, namely at the eigenvalues of $\hat H$. For
  now, we assume the spectrum is discrete.
\end{note}

Let $\{E_i\}$ be the eigenvalues and let $\hat P_i$ denote the
projector onto the eigenspace associated with $E_i$. We know that
$\hat P_i = \ketbra{E_i}$ for a nondegenerate eigenvalue $E_i$ and
normalized eigenvectors $\ket{E_i}$. We assume that all eigenvalues
are non-degenerate. These projectors satisfy
orthogonality and completeness.

\begin{lemma}[Orthogonality of Projectors]
  For distinct eigenvalues $E_i$ and $E_j$, the projectors $\hat
  P_i$ and $\hat P_j$ are orthogonal:
  \begin{equation} \label{eq:projector_orthogonality}
    \hat P_i \hat P_j= \delta_{ij} \hat P_i
  \end{equation}
\end{lemma}
\begin{proof}
  For normalized eigenvectors $\ket{E_i}$, $\hat P_i = \ketbra{E_i}$.
  \begin{align}
    \hat P_i \hat P_j &= (\ketbra {E_i})(\ketbra {E_j}) \\
    &= \ket{E_i} \braket{E_i} {E_j} \bra {E_j} \\
    &= \braket{E_j} {E_i} \ketbra {E_i} {E_j} \\
    &= \delta_{ij} \ketbra {E_i} \\
    &= \delta_{ij} \hat P_i
  \end{align}
\end{proof}

\begin{definition}[Completeness Relation]
  The sum of all projectors onto the eigenspaces of a complete set
  of eigenvalues forms the identity operator:
  \begin{equation} \label{eq:completeness_relation}
    \sum_i \hat P_i = \hat I
  \end{equation}
\end{definition}

\begin{lemma}
  The Hamiltonian operator acts on a projector $\hat P_i$ such that:
  \begin{equation} \label{eq:H_P_i_relation}
    \hat H \hat P_i = E_i \hat P_i
  \end{equation}
\end{lemma}
\begin{proof}
  Let $\psi \in \mathcal{H}$. $\hat P_i \ket{\psi} = c \ket{E_i}$
  for some scalar $c$, as
  $\hat P_i$ projects onto the eigenspace of $E_i$.
  Now, apply $\hat H$ to $\hat P_i \ket{\psi}$:
  \begin{align} \label{eq:H_P_i_proof}
    \hat H \hat P_i \ket{\psi} &= \hat H (c \ket{E_i}) \\
    &= c (\hat H \ket{E_i}) \notag \\
    &= c (E_i \ket{E_i}) \quad &\text{(since } \ket{E_i} \text{
    is an eigenstate of } \hat H \text{)} \notag \\
    &= E_i (c \ket{E_i}) \notag \\
    &= E_i (\hat P_i \ket{\psi}) \notag
  \end{align}
  Since this relationship holds for every $\ket{\psi}$ in the
  Hilbert space, we can conclude that $\hat H \hat P_i = E_i \hat P_i$.
\end{proof}

\begin{proposition}[Spectral Decomposition of the Resolvent]
  The resolvent operator $\hat G(z)$ can be expressed as a sum over
  the projectors of the Hamiltonian's eigenspaces:
  \begin{equation} \label{eq:resolvent_spectral_decomposition}
    \hat G(z) = \sum_i \frac{\hat P_i}{z - E_i}
  \end{equation}
\end{proposition}
\begin{proof}
  From \eqref{eq:H_P_i_relation}, we have $\hat H \hat P_i = E_i \hat P_i$.
  Rearranging this, we get $(z - \hat H) \hat P_i = (z - E_i) \hat P_i$.
  Left-multiplying by $\hat G(z) = (z - \hat H)^{-1}$:
  \begin{align} \label{eq:resolvent_derivation}
    \hat G(z) (z - \hat H) \hat P_i &= \hat G(z) (z - E_i) \hat P_i \\
    \hat I \hat P_i &= \hat G(z) (z - E_i) \hat P_i \notag \\
    \hat P_i &= (z - E_i) \hat G(z) \hat P_i \notag
  \end{align}
  This implies that $\hat G(z) \hat P_i = \frac{\hat P_i}{z - E_i}$.
  Summing over all $i$ and using the completeness relation
  \eqref{eq:completeness_relation}:
  \begin{align}
    \sum_i \hat G(z) \hat P_i &= \sum_i \frac{\hat P_i}{z - E_i} \\
    \hat G(z) \sum_i \hat P_i &= \sum_i \frac{\hat P_i}{z - E_i} \notag \\
    \hat G(z) \hat I &= \sum_i \frac{\hat P_i}{z - E_i} \notag \\
    \hat G(z) &= \sum_i \frac{\hat P_i}{z - E_i} \notag
  \end{align}
  This formula shows that each discrete eigenvalue $E_i$ is a
  simple pole of $\hat G(z)$.
\end{proof}

\begin{theorem}[Residue of the Resolvent]
  The residue of the resolvent $\hat G(z)$ at a simple pole $E_i$
  is the corresponding projector $\hat P_i$.
  \begin{equation} \label{eq:resolvent_residue}
    \frac{1}{2\pi i}\oint_{\Gamma_i} \hat G(z)\mathrm dz = \hat P_i
  \end{equation}
  where $\Gamma_i$ is a small contour enclosing only $E_i$.
\end{theorem}
\begin{proof}
  Using the spectral decomposition
  \eqref{eq:resolvent_spectral_decomposition}, we can calculate the
  residue directly:
  \begin{align}
    \frac{1}{2\pi i}\oint_{\Gamma_i} \hat G(z)\mathrm dz &=
    \frac{1}{2\pi i}\oint_{\Gamma_i} \sum_j \frac{\hat P_j}{z -
    E_j}\mathrm dz \\
    &= \sum_j \frac{1}{2\pi i}\oint_{\Gamma_i} \frac{\hat P_j}{z
    - E_j}\mathrm dz \notag
  \end{align}
  By Cauchy's residue theorem, only the term where $E_j$ is inside
  $\Gamma_i$ contributes. Since $\Gamma_i$ only encloses $E_i$:
  \begin{align}
    &= \frac{1}{2\pi i}\oint_{\Gamma_i} \frac{\hat P_i}{z -
    E_i}\mathrm dz \\
    &= \hat P_i \cdot 1 \notag \\
    &= \hat P_i \notag
  \end{align}
  This result is significant as it provides a way to extract
  projectors using contour integrals.
\end{proof}

\begin{theorem}[Projector for a Set of Eigenvalues]
  For any closed contour $\Gamma$ that encloses a set of
  eigenvalues $\{E_j\}$ and excludes all
  others, the sum of the associated projectors, $\hat P_\Gamma$, is given by:
  \begin{equation} \label{eq:projector_contour_integral}
    \hat P_\Gamma=\frac{1}{2\pi i}\oint_{\Gamma} \hat G(z)\mathrm dz
  \end{equation}
  Furthermore, multiplying by $\hat H$:
  \begin{equation} \label{eq:H_projector_contour_integral}
    \hat H \hat P_\Gamma= \frac{1}{2\pi i}\oint_{\Gamma} z\hat
    G(z)\mathrm dz
  \end{equation}
\end{theorem}
\begin{proof}
  The first part follows directly from summing the residues for all
  $E_j$ inside $\Gamma$.
  For the second part, using $(z-\hat H)\hat G(z) = \hat I$:
  \begin{align}
    \hat H \hat P_\Gamma &= \hat H \left(\frac{1}{2\pi
    i}\oint_{\Gamma} \hat G(z)\mathrm dz\right) \\
    &= \frac{1}{2\pi i}\oint_{\Gamma} \hat H \hat G(z)\mathrm dz \notag \\
    &= \frac{1}{2\pi i}\oint_{\Gamma} (z\hat G(z) - \hat
    I)\mathrm dz \quad &\text{(since } \hat H \hat G(z) = z\hat
    G(z) - \hat I \text{)} \notag \\
    &= \frac{1}{2\pi i}\oint_{\Gamma} z\hat G(z)\mathrm dz -
    \frac{1}{2\pi i}\oint_{\Gamma} \hat I \mathrm dz \notag \\
    &= \frac{1}{2\pi i}\oint_{\Gamma} z\hat G(z)\mathrm dz - 0 \notag \\
    &= \frac{1}{2\pi i}\oint_{\Gamma} z\hat G(z)\mathrm dz \notag
  \end{align}
  The integral of $\hat I$ over a closed contour is zero, assuming
  the contour is finite and well-behaved.
\end{proof}

\begin{theorem}[Norm of the Resolvent]
  The norm of the resolvent operator is given by the reciprocal of
  the distance from $z$ to the closest eigenvalue:
  \begin{equation} \label{eq:resolvent_norm}
    \|\hat G(z)\|=\frac{1}{\Delta(z)}
  \end{equation}
  where $\Delta(z) = \min_i |z-E_i|$ is the distance from $z$ to
  the closest eigenvalue $E_i$.
\end{theorem}
\begin{proof}
  For any state $\ket{\psi} = \sum_i \ket{\psi_i}$ with
  $\ket{\psi_i}=\hat P_i\ket{\psi}$, we can write:
  \begin{align}
    \|\hat G(z)\ket{\psi}\|^2 &= \left\|\sum_i \frac{\hat P_i
    \ket{\psi}}{z-E_i}\right\|^2 \\
    &= \left\|\sum_i \frac{\ket{\psi_i}}{z-E_i}\right\|^2 \notag
  \end{align}
  Since the $\ket{\psi_i}$ components are orthogonal (as they lie
  in orthogonal eigenspaces), the norm squared is:
  \begin{align}
    &= \sum_i \left\|\frac{\ket{\psi_i}}{z-E_i}\right\|^2 \notag \\
    &= \sum_i \frac{\|\ket{\psi_i}\|^2}{|z-E_i|^2} \notag \\
    &\le \left(\max_i \frac{1}{|z-E_i|^2}\right) \sum_i
    \|\ket{\psi_i}\|^2 \notag \\
    &= \left(\max_i \frac{1}{|z-E_i|^2}\right)\|\ket{\psi}\|^2 \notag
  \end{align}
  Taking the square root, we get $\|\hat G(z)\|\le \max_i
  \frac{1}{|z-E_i|} = \frac{1}{\min_i |z-E_i|} = \frac{1}{\Delta(z)}$.

  To show equality, choose a state $\ket{\psi}$ that lies entirely
  within an eigenspace corresponding to an eigenvalue $E_k$ such
  that $|z-E_k| = \Delta(z)$. For such a state, $\hat
  G(z)\ket{\psi} = \frac{1}{z-E_k}\ket{\psi}$.
  Then, $\|\hat G(z)\ket{\psi}\| = \left|\frac{1}{z-E_k}\right|
  \|\ket{\psi}\| = \frac{1}{\Delta(z)} \|\ket{\psi}\|$.
  Therefore, the operator norm is exactly $\frac{1}{\Delta(z)}$.
\end{proof}

\hr
\subsection{§16 Expansion of $\hat G(z)$, $\hat P$ and $\hat H \hat
P$ in powers of $\lambda \hat V$}
\begin{definition}[Perturbed and Unperturbed Resolvents]
  We write the perturbed Hamiltonian as $\hat H=\hat H_0+\lambda
  \hat V$, where $\lambda$ is a bookkeeping parameter. The
  unperturbed and full resolvents are defined as:
  \begin{align} \label{eq:unperturbed_resolvent}
    \hat G_0(z) &=\frac{1}{z-\hat H_0} \\
    \hat G(z) &=\frac{1}{z-\hat H_0-\lambda \hat V}
  \end{align}
\end{definition}

\begin{proposition}[Equation for Resolvents]
  The full resolvent $\hat G(z)$ can be expressed in terms of the
  unperturbed resolvent $\hat G_0(z)$ and the perturbation $\hat V$ as:
  \begin{equation} \label{eq:dyson_equation}
    \hat G=\hat G_0(z)(1+\lambda \hat V \hat G(z))
  \end{equation}
\end{proposition}
\begin{proof}
  We start with the definition of $\hat G(z)$:
  \begin{align} \label{eq:dyson_derivation}
    \hat G(z) &= \frac{1}{z - \hat H_0 - \lambda \hat V} \\
    &= \frac{1}{z - \hat H_0 - \lambda \hat V} \notag \\
    &= \frac{1}{z - \hat H_0} (z - \hat H_0) \frac{1}{z - \hat
    H_0 - \lambda \hat V} \notag \\
    &= \frac{1}{z - \hat H_0} [(z - \hat H_0 - \lambda \hat V) +
    \lambda \hat V] \frac{1}{z - \hat H_0 - \lambda \hat V} \notag \\
    &= \frac{1}{z - \hat H_0} (z - \hat H_0 - \lambda \hat V)
    \frac{1}{z - \hat H_0 - \lambda \hat V} + \frac{1}{z - \hat
    H_0} \lambda \hat V \frac{1}{z - \hat H_0 - \lambda \hat V} \notag \\
    &= \frac{1}{z - \hat H_0} \hat I + \frac{1}{z - \hat H_0}
    \lambda \hat V \hat G(z) \notag \\
    &= \hat G_0(z) + \hat G_0(z) \lambda \hat V \hat G(z) \notag \\
    &= \hat G_0(z) ( \hat I + \lambda \hat V \hat G(z) ) \notag
  \end{align}
\end{proof}

\begin{theorem}[Neumann Series Expansion of the Resolvent]
  The full resolvent $\hat G(z)$ can be expressed as a Neumann series:
  \begin{equation} \label{eq:neumann_series_resolvent}
    \hat G(z) = \sum_{n=0}^\infty \lambda^n \hat G_0(z) (\hat V
    \hat G_0(z))^n
  \end{equation}
  This series converges when $\|\lambda \hat V \hat G_0(z)\| < 1$.
\end{theorem}
\begin{proof}
  From Proposition 2, we have $\hat G = \hat G_0 + \hat G_0
  \lambda \hat V \hat G$. We can rearrange this to isolate $\hat G$:
  \begin{align}
    \hat G - \hat G_0 \lambda \hat V \hat G &= \hat G_0 \\
    (\hat I - \hat G_0 \lambda \hat V) \hat G &= \hat G_0 \notag \\
    \hat G &= (\hat I - \hat G_0 \lambda \hat V)^{-1} \hat G_0 \notag
  \end{align}
  Using the geometric series expansion for operators, $(\hat I -
  \hat X)^{-1} = \sum_{n=0}^\infty \hat X^n$, which converges if
  the operator norm $\|\hat X\| < 1$. Here, $\hat X = \hat G_0
  \lambda \hat V$. So, the series converges if $\|\hat G_0 \lambda
  \hat V\| < 1$.
  \begin{align} \label{eq:neumann_series_derivation}
    \hat G &= \left( \sum_{n=0}^\infty (\hat G_0 \lambda \hat
    V)^n \right) \hat G_0 \\
    &= \sum_{n=0}^\infty \lambda^n (\hat G_0 \hat V)^n \hat G_0 \notag \\
    &= \sum_{n=0}^\infty \lambda^n \hat G_0 (\hat V \hat G_0)^n \notag
  \end{align}
  The convergence condition is $\|\lambda \hat V \hat G_0\| < 1$
  . Since $\|\hat G_0(z)\|=1/\Delta_0(z)$ (where
    $\Delta_0(z)$ is the distance from $z$ to the nearest eigenvalue
  of $\hat H_0$), a sufficient condition for convergence is
  $\|\lambda \hat V\| < \Delta_0(z)$. This means that the
  perturbation must be sufficiently small.
\end{proof}

\begin{proposition}[Expansion of the Projector $\hat P$]
  The projector $\hat P$ onto an eigenspace of the perturbed
  Hamiltonian can be expanded as a power series in the perturbation
  parameter $\lambda$:
  \begin{equation} \label{eq:projector_expansion}
    \hat P = \hat P_a+\sum_{n=1}^{\infty}\lambda^n \hat A^{(n)}
  \end{equation}
  where $\hat P_a$ is the unperturbed projector and $\hat
  A^{(n)}=\frac{1}{2\pi i}\oint_{\Gamma_a} \hat G_0(\hat V \hat
  G_0)^n \mathrm dz$.
\end{proposition}
\begin{proof}
  Let $\Gamma_a$ be a contour that encloses the unperturbed
  eigenvalue $E_a^0$ and the eigenvalues of $\hat H$ that tend to
  $E_a^0$ for small $\lambda$. From the residue formula
  \eqref{eq:projector_contour_integral}, the projector $\hat P$ is:
  \begin{equation}
    \hat P=\frac{1}{2\pi i}\oint_{\Gamma_a} \hat G(z)\mathrm d z
  \end{equation}
  Substituting the Neumann series for $\hat G(z)$ from
  \eqref{eq:neumann_series_resolvent}:
  \begin{align} \label{eq:projector_expansion_derivation}
    \hat P &= \frac{1}{2 \pi i} \oint_{\Gamma_a}
    \sum_{n=0}^\infty \lambda^n \hat G_0(z) (\hat V \hat
    G_0(z))^n \mathrm d z \\
    &= \frac{1}{2 \pi i} \oint_{\Gamma_a} \hat G_0(z) \mathrm d z
    + \sum_{n=1}^\infty \lambda^n \left(\frac{1}{2 \pi i}
      \oint_{\Gamma_a} \hat G_0(z) (\hat V \hat G_0(z))^n \mathrm d
    z\right) \notag
  \end{align}
  The first term is the projector onto the unperturbed eigenspace
  corresponding to $E_a^0$, denoted $\hat P_0$.
  The remaining terms define $\hat A^{(n)}$:
  \begin{equation}
    \hat P = \hat P_a+\sum_{n=1}^{\infty}\lambda^n \hat A^{(n)}
  \end{equation}
\end{proof}

To evaluate the residues for $\hat A^{(n)}$, we expand $\hat G_0(z)$
about $E_a^0$ in a Laurent series.
Let $\hat Q_a := \hat I-\hat P_a = \sum_{i \ne a} \hat P_i$, which is
the projector onto the subspace orthogonal to the unperturbed
eigenspace of $E_a^0$.
\begin{definition}[Laurent Series of Unperturbed Resolvent]
  The unperturbed resolvent $\hat G_0(z)$ can be written in terms
  of projectors:
  \begin{equation} \label{eq:G0_projector_sum}
    \hat G_0(z)=\frac{\hat P_a}{z-E_a^0}+\sum_{i\neq a}\frac{\hat
    P_i}{z-E_i^0}
  \end{equation}
\end{definition}

For $|z-E_a^0|<\min_{i\neq a}|E_i^0-E_a^0|$, we can expand the second
term as a geometric series. Expanding a single term $\frac{1}{z-E_i^0}$:
\begin{align} \label{eq:geometric_series_expansion}
  \frac{1}{z-E_i^0}
  &= \frac{1}{(z-E_a^0) - (E_i^0 - E_a^0)} \\
  &= \frac{1}{E_i^0 - E_a^0} \frac{E_i^0 - E_a^0}{(z-E_a^0) -
  (E_i^0 - E_a^0)} \\
  &= -\frac{1}{E_i^0 - E_a^0} \frac{1}{1-\frac{z-E_a^0}{E_i^0-E_a^0}} \\
  &= -\sum_{k=0}^\infty \frac{(z-E_a^0)^k}{(E_i^0-E_a^0)^{k+1}}
\end{align}
The convergence condition for this geometric series is
$\left|\frac{z-E_a^0}{E_i^0-E_a^0}\right| < 1$.
Summing over $i \ne a$:
\begin{equation} \label{eq:G0_sum_expansion}
  \sum_{i\neq a}\frac{\hat P_i}{z-E_i^0}
  =\sum_{k=0}^\infty (-1)^k (z-E_a^0)^k
  \sum_{i\neq a}\frac{\hat P_i}{(E_a^0-E_i^0)^{k+1}}
\end{equation}

\begin{definition}[Operator $\hat O_a$]
  Define the operator $\hat O_a$, which is the inverse of $(E_a^0 -
  \hat H_0)$ on the $\hat Q_a$ subspace:
  \begin{equation} \label{eq:kato_operator_O_a_definition}
    \hat O_a := \hat Q_a (E_a^0 - \hat H_0)^{-1} \hat Q_a
  \end{equation}
\end{definition}

\begin{lemma}[Explicit Form of $\hat O_a$]
  The operator $\hat O_a$ can be explicitly written as:
  \begin{equation} \label{eq:kato_operator_O_a_sum_form}
    \hat O_a = \sum_{i \ne a}\frac{1}{E_a^0 - E_i^0} \hat P_i
  \end{equation}
\end{lemma}
\begin{proof}
  Consider the operator $\hat X = \sum_{i \ne a}\frac{1}{E_a^0 -
  E_i^0} \hat P_i$. We need to show that this is the inverse of
  $(E^0_a - \hat H_0)$ on the $\hat Q_a$ subspace. This means we
  need to show $(E^0_a - \hat H_0) \hat X = \hat Q_a$ and $\hat X
  (E^0_a - \hat H_0) = \hat Q_a$.

  First, consider $(E^0_a - \hat H_0) \hat X$:
  \begin{align} \label{eq:O_a_inverse_proof1}
    (E^0_a - \hat H_0) \hat X &= (E_a^0 - \hat H_0) \left(
    \sum_{i \ne a} \frac{\hat P_i}{E_a^0 - E_i^0} \right) \\
    &= \left( \sum_{j} (E_a^0 - E_j^0) \hat P_j \right) \left(
    \sum_{i \ne a} \frac{\hat P_i}{E_a^0 - E_i^0} \right) \notag
  \end{align}
  Using the orthogonality of projectors $\hat P_j \hat P_i =
  \delta_{ji} \hat P_i$:
  \begin{align}
    &= \sum_{j} \sum_{i \ne a} \frac{(E_a^0 - E_j^0)}{(E_a^0 -
    E_i^0)} \hat P_j \hat P_i \notag \\
    &= \sum_{i \ne a} \frac{(E_a^0 - E_i^0)}{(E_a^0 - E_i^0)}
    \hat P_i \notag \\
    &= \sum_{i \ne a} \hat P_i \notag \\
    &= \hat Q_a \notag
  \end{align}
  Now, consider $\hat X (E^0_a - \hat H_0)$:
  \begin{align} \label{eq:O_a_inverse_proof2}
    \hat X (E^0_a - \hat H_0) &=  \left( \sum_{i \ne a}
    \frac{\hat P_i}{E_a^0 - E_i^0} \right) \left( \sum_{j} (E_a^0
    - E_j^0) \hat P_j \right) \\
    &= \sum_{i \ne a} \sum_{j} \frac{(E_a^0 - E_j^0)}{(E_a^0 -
    E_i^0)} \hat P_i \hat P_j \notag \\
    &= \sum_{i \ne a} \frac{(E_a^0 - E_i^0)}{(E_a^0 - E_i^0)}
    \hat P_i \notag \\
    &= \sum_{i \ne a} \hat P_i \notag \\
    &= \hat Q_a \notag
  \end{align}
  Thus, we have shown that $\hat X$ is the left and right inverse
  of $(E^0_a - \hat H_0)$ in the $\hat Q_a$ subspace, which is
  precisely the definition of $\hat O_a$. Therefore, $\hat O_a =
  \sum_{i \ne a}\frac{1}{E_a^0 - E_i^0} \hat P_i$.
\end{proof}

\begin{lemma}[Powers of $\hat O_a$]
  The $k$-th power of $\hat O_a$ is given by:
  \begin{equation} \label{eq:O_a_power_k}
    (\hat O_a)^k = \sum_{i \ne a} \frac{\hat P_i}{(E_a^0 - E_i^0)^k}
  \end{equation}
\end{lemma}
\begin{proof}
  This can be shown by induction. For $k=1$, it is the definition
  of $\hat O_a$. Assuming it holds for $k$, we show for $k+1$:
  \begin{align} \label{eq:O_a_power_k_proof}
    (\hat O_a)^{k+1} &= (\hat O_a)^k \hat O_a \\
    &= \left( \sum_{j \ne a} \frac{\hat P_j}{(E_a^0 - E_j^0)^k}
    \right) \left( \sum_{i \ne a} \frac{\hat P_i}{E_a^0 - E_i^0}
    \right) \notag \\
    &= \sum_{j \ne a} \sum_{i \ne a} \frac{\hat P_j \hat
    P_i}{(E_a^0 - E_j^0)^k (E_a^0 - E_i^0)} \notag \\
    &= \sum_{i \ne a} \frac{\hat P_i}{(E_a^0 - E_i^0)^k (E_a^0 -
    E_i^0)} \quad &\text{(since } \hat P_j \hat P_i =
    \delta_{ji} \hat P_i \text{)} \notag \\
    &= \sum_{i \ne a} \frac{\hat P_i}{(E_a^0 - E_i^0)^{k+1}} \notag
  \end{align}
  This completes the proof.
\end{proof}

Substituting \eqref{eq:O_a_power_k} into \eqref{eq:G0_sum_expansion},
we can simplify the Laurent series for the unperturbed resolvent:
\begin{align} \label{eq:G0_laurent_simplified}
  \hat G_0(z) &= \frac{\hat P_a}{z - E_a^0} + \sum_{k=0}^\infty
  (-1)^k (z-E_a^0)^k \sum_{i\neq a}\frac{\hat P_i}{(E_a^0-E_i^0)^{k+1}} \\
  &= \frac{\hat P_a}{z-E_a^0} + \sum_{k=0}^\infty (-1)^k
  (z-E_a^0)^k (\hat O_a)^{k+1} \notag \\
  &= \frac{\hat P_a}{z-E_a^0} - \sum_{k=1}^\infty (-1)^{k-1}
  (z-E_a^0)^{k-1} (\hat O_a)^{k} \notag \\
  &= \frac{\hat P_a}{z-E_a^0} + \sum_{k=1}^\infty (-1)^{k-1}
  (z-E_a^0)^{k-1} \hat O_a^k \notag
\end{align}
This expression is a Laurent series where the principal part
corresponds to the projector $\hat P_a$ and the analytic part
involves powers of $\hat O_a$.

\begin{definition}[Kato's Operators $\hat S^k$]
  Kato’s operators $\hat S^k$ are defined as:
  \begin{equation} \label{eq:kato_operators_S_k}
    \hat S^k=
    \begin{cases}
      -\hat P_a,& k=0,\\[2pt]
      \hat O_a^k,& k\ge 1.
    \end{cases}
  \end{equation}
\end{definition}

Using these operators, the Laurent expansion of $\hat G_0(z)$ around
$E_a^0$ can be written compactly as:
\begin{equation} \label{eq:G0_laurent_kato}
  \hat G_0(z)=\sum_{k=0}^{\infty}(-1)^{k-1}(z-E_a^0)^{k-1} \hat S^k
\end{equation}
Multiplying both sides by $\hat V$,
\begin{equation}
  \hat V \hat G _{0} = \sum _{k=0}^{\infty} (-1) ^{k-1}(z - E
  _{a}^{0})^{k-1} \hat V \hat S ^{k}
\end{equation}
Now we use this compact form to expand $(\hat V \hat G_0)^n$:
\begin{align} \label{eq:V_G0_n_expansion}
  (\hat V \hat G_0)^n
  &=\prod_{j=1}^{n}\left(\hat V \sum_{k_j\ge
  0}(-1)^{k_j-1}(z-E_a^0)^{k_j-1}\hat S^{k_j}\right) \\
  &= \prod_{j=1}^{n} \Big( \hat V
    \big[(-1)^{-1}(z-E_a^{0})^{-1}\hat S^{0} +
      (-1)^{0}(z-E_a^{0})^{0}\hat S^{1} + (-1)^{1}(z-E_a^{0})^{1}\hat
  S^{2} + \cdots \big] \Big) \notag\ \\
  &= \prod_{j=1}^{n} \Big( -
    (z-E_a^{0})^{-1}\hat V + \hat V\hat
  S - (z-E_a^{0})\hat V\hat S^{2} + \cdots \Big) \\
  &= \Big( -
    (z-E_a^{0})^{-1}\hat V + \hat V\hat
  S - (z-E_a^{0})\hat V\hat S^{2} + \cdots \Big) \notag \\
  & \quad \times \Big( - (z-E_a^{0})^{-1}\hat V + \hat V\hat
  S - (z-E_a^{0})\hat V\hat S^{2} + \cdots \Big) \times \cdots
\end{align}
As we can see, each element in the distributed product will contain
one element from each sum. We can reorder and combine the scalars
since they commute, while the operators must retain their order.
\begin{align}
  (\hat V \hat G _{0})^{n}  &=\prod_{j=1}^{n}\left(\sum_{k_j\ge
  0}(-1)^{k_j-1}(z-E_a^0)^{k_j-1}\hat V \hat S^{k_j}\right) \\
  &=\sum_{k_1,\cdots,k_n\ge 0}
  \left[\prod_{j=1}^{n}(-1)^{k_j-1}(z-E_a^0)^{k_j-1}\right]
  (\hat V \hat S^{k_1})\cdots(\hat V \hat S^{k_n}) \\
  &=\sum_{k_1,\cdots,k_n\ge 0}
  (-1)^{\left(\sum_{j=1}^{n}k_j\right)-n}
  (z-E_a^0)^{\left(\sum_{j=1}^{n}k_j\right)-n}
  (\hat V \hat S^{k_1})\cdots(\hat V \hat S^{k_n})
\end{align}

Finally, we combine $\hat G_0$ with $(\hat V \hat G_0)^n$:
\begin{align} \label{eq:G0_V_G0_n_expansion}
  \hat G_0(\hat V \hat G_0)^n
  &=\left[\sum_{k_0\ge 0}(-1)^{k_0-1}(z-E_a^0)^{k_0-1}\hat
  S^{k_0}\right] \notag \\
  &\quad \times \left[\sum_{k_1,\cdots,k_n\ge 0}
    (-1)^{\left(\sum_{j=1}^{n}k_j\right)-n}
    (z-E_a^0)^{\left(\sum_{j=1}^{n}k_j\right)-n}
  (\hat V \hat S^{k_1})\cdots(\hat V \hat S^{k_n})\right] \\
  &= \Big[ - (z-E_a^{0})^{-1}\hat S^{0} + \hat S^{1} - (z-E_a^{0})
  \hat S^{2} + \cdots \Big] \notag \\
  &\quad \times \left[\sum_{k_1,\cdots,k_n\ge 0}
    (-1)^{\left(\sum_{j=1}^{n}k_j\right)-n}
    (z-E_a^0)^{\left(\sum_{j=1}^{n}k_j\right)-n}
  (\hat V \hat S^{k_1})\cdots(\hat V \hat S^{k_n})\right]
\end{align}
Again, the final product will contain one element from each of the
sums. We can reorder the scalars since they commute but the operators
retain their initial order, with $\hat S ^{k_0}$ appearing first.
\begin{equation}
  \hat G_0(\hat V \hat G_0)^n =\sum_{k_0,\cdots,k_n\ge 0}
  (-1)^{(k_0-1)+\left(\sum_{j=1}^{n}k_j\right)-n}
  (z-E_a^0)^{(k_0-1)+\left(\sum_{j=1}^{n}k_j\right)-n}
  \big(\hat S^{k_0} \hat V \hat S^{k_1}\cdots \hat V \hat S^{k_n}\big)
\end{equation}

Let $K=\sum_{j=0}^{n}k_j$. The coefficient of $(z-E_a^0)^{-1}$ (which
corresponds to the residue and thus $\hat A^{(n)}$) occurs when the
exponent $(k_0-1)+\left(\sum_{j=1}^{n}k_j\right)-n = K - (n+1)$ equals $-1$.
This implies $K - (n+1) = -1$, so $K = n$.
Therefore, $k_0+\cdots+k_n=n$.
Hence, the expression for $\hat A^{(n)}$ is
$=-\sum_{\substack{k_0,\cdots,k_n\ge 0\\ k_0+\cdots+k_n=n}}
\hat S^{k_0} \hat V \hat S^{k_1}\cdots \hat V \hat S^{k_n}$. We
reindex the sum from $k_0, k_1, \cdots k_n$ to $k_1, k_2, \cdots
k_{n+1}$ to match the form in the textbook.
\begin{theorem}[Explicit Form of $\hat A^{(n)}$]
  \begin{equation} \label{eq:A_n_final}
    \hat A^{(n)} = - \sum_{(n)} \hat S^{k_1} \hat V \hat
    S^{k_2}\cdots \hat V \hat
    S^{k_{n+1}},
    \quad \text{where } k_1+\cdots+k_{n+1}=n
  \end{equation}
\end{theorem}

Now, we calculate the first few coefficients $\hat A _{n}$. Recall
equation \eqref{eq:kato_operators_S_k}.
\begin{align}
  \hat A ^{(0)} &= - \sum _{0} \hat S ^{k _{1}} \\
  &= - (- \hat P _{a}) = \hat P _{a} \\
  \hat A ^{(1)} &= - \sum _{1} \hat S ^{k _{1}} \hat V \hat S ^{k _{2}} \\
  &= - (\hat S _{0} \hat V \hat S _{1} + \hat S _{1} \hat V \hat S _{0}) \\
  &= - (- \hat P _{a} \hat V \hat O _{a} + - \hat O _{a} \hat V \hat P _{a}) \\
  &= \hat P _{a} \hat V \hat O _{a} + \hat O _{a} \hat V \hat P _{a} \\
  \hat A ^{(2)} &= - \sum _{2} \hat S ^{k _{1}} \hat V \hat S ^{k _{2}}
  \hat V \hat S ^{k _{3}} \\
  &= - \Big(
    \hat S _{2} \hat V \hat S _{0} \hat V \hat S _{0}
    + \hat S _{0} \hat V \hat S _{2} \hat V \hat S _{0}
    + \hat S _{0} \hat V \hat S _{0} \hat V \hat S _{2}
    + \hat S _{1} \hat V \hat S _{1} \hat V \hat S _{0}
    + \hat S _{1} \hat V \hat S _{0} \hat V \hat S _{1}
    + \hat S _{0} \hat V \hat S _{1} \hat V \hat S _{1}
  \Big) \notag \\
  &= - \Big(
    \hat O _{a}^{2} \hat V (-\hat P _{a}) \hat V (-\hat P _{a})
    + (-\hat P _{a}) \hat V \hat O _{a}^{2} \hat V (-\hat P _{a})
    + (-\hat P _{a}) \hat V (-\hat P _{a}) \hat V \hat O _{a}^{2} \notag \\
    &\quad + \hat O _{a} \hat V \hat O _{a} \hat V (-\hat P _{a})
    + \hat O _{a} \hat V (-\hat P _{a}) \hat V \hat O _{a}
    + (-\hat P _{a}) \hat V \hat O _{a} \hat V \hat O _{a}
  \Big) \\
  &=\hat O _{a} \hat V \hat O _{a} \hat V \hat P _{a}
  + \hat O _{a} \hat V \hat P _{a} \hat V \hat O _{a}
  + \hat P _{a} \hat V \hat O _{a} \hat V \hat O _{a} \\
  &\quad
  - \hat O _{a}^{2} \hat V \hat P _{a} \hat V \hat P _{a}
  - \hat P _{a} \hat V \hat O _{a}^{2} \hat V \hat P _{a}
  - \hat P _{a} \hat V \hat P _{a} \hat V \hat O _{a}^{2}
\end{align}
Now, we can write out the expansion $\hat P$ to the 2nd order.
\begin{align}
  \hat P = \hat P_a
  &+ \lambda\left(\hat P_a \hat V \hat O_a + \hat O_a \hat V \hat
  P_a\right) \notag\\
  &
  + \lambda^{2}\Big(
    \hat O_a \hat V \hat O_a \hat V \hat P_a
    + \hat O_a \hat V \hat P_a \hat V \hat O_a
    + \hat P_a \hat V \hat O_a \hat V \hat O_a \notag\\
    &\qquad
    - \hat O_a^{2} \hat V \hat P_a \hat V \hat P_a
    - \hat P_a \hat V \hat O_a^{2} \hat V \hat P_a
    - \hat P_a \hat V \hat P_a \hat V \hat O_a^{2}
  \Big).
\end{align}

\begin{proposition}[Expansion of $(\hat H-E_a^{0})\hat P$]
  \begin{equation}
    (\hat H-E_a^{0})\hat P=\sum_{n=1}^{\infty}\lambda^{n}\hat B^{(n)},
    \qquad
    \hat B^{(n)}:=(\hat H_0-E_a^{0})\hat A^{(n)}+\hat V\hat
    A^{(n-1)}\ \ (n\ge1).
  \end{equation}
\end{proposition}

\begin{proof}
  Starting from $\hat H=\hat H_0+\lambda \hat V$ and the series for $\hat P$,
  \begin{align*}
    (\hat H-E_a^{0})\hat P
    &=\big(\hat H_0-E_a^{0}\big)\hat P+\lambda\hat V\hat P \\
    &=\big(\hat H_0-E_a^{0}\big)\left(\hat
    P_a+\sum_{n=1}^{\infty}\lambda^{n}\hat A^{(n)}\right)
    +\lambda\hat V\left(\hat
    P_a+\sum_{n=1}^{\infty}\lambda^{n}\hat A^{(n)}\right).
  \end{align*}
  Using $(\hat H_0-E_a^{0})\hat P_a=0$ and reindexing the second sum,
  $\lambda \hat V\left(\hat
  P_a+\sum_{n=1}^{\infty}\lambda^{n}\hat A^{(n)}\right) = \lambda
  \hat V \hat P_a + \lambda \sum _{n = 1} ^{\infty} \lambda ^{n+1} \hat
  V \hat A ^{(n)} = \sum_{n=0}^{\infty}\lambda^{n+1}\hat V\hat A^{(n)}$.
  \begin{align*}
    (\hat H-E_a^{0})\hat P
    &=\sum_{n=1}^{\infty}\lambda^{n}(\hat H_0-E_a^{0})\hat A^{(n)}
    +\sum_{n=0}^{\infty}\lambda^{n+1}\hat V\hat A^{(n)} \\
    &=\sum_{n=1}^{\infty}\lambda^{n}(\hat H_0-E_a^{0})\hat A^{(n)}
    +\sum_{n=0}^{\infty}\lambda^{n+1}\hat V\hat A^{(n)} \\
    &=\sum_{n=1}^{\infty}\lambda^{n}\Big[(\hat H_0-E_a^{0})\hat A^{(n)}
    +\hat V\hat A^{(n-1)}\Big].
  \end{align*}
  Defining $\hat B^{(n)}$ as stated yields
  $(\hat H-E_a^{0})\hat P=\sum_{n=1}^{\infty}\lambda^{n}\hat B^{(n)}$.
\end{proof}
With $\hat A^{(1)}=\hat P_0\hat V\hat O_a+\hat O_a\hat V\hat P_0$ and
$(\hat H_0-E_a^{0})\hat P_0=0,\ (\hat H_0-E_a^{0})\hat O_a=-\hat Q_a$,
\[
  \hat B^{(1)}=(\hat H_0-E_a^{0})\hat A^{(1)}+\hat V\hat A^{(0)}
  =-\hat Q_a\hat V\hat P_0+\hat V\hat P_0=\hat P_0\hat V\hat P_0.
\]
\hr
\section{Perturbation Series from the
Resolvent Trace}

In this section we obtain the (nondegenerate) Rayleigh–Schrödinger
energy series directly from
the trace of the full resolvent. We assume:
(i) $\hat H$ is self-adjoint with purely discrete spectrum
$\{E_n\}$, and complete orthonormal eigenbases $\{\ket{E_n}\}$ (ii)
each eigenspace is $1$-dimensional (eigenvalues are non-degenerate).

\begin{definition}
  For $z\in\mathbb C\setminus \sigma(\hat H)$, the resolvent is $\hat
  G(z):=(z-\hat H)^{-1}$ and we denote
  \[
    F(z):=\Tr\hat G(z).
  \]
\end{definition}

\begin{proposition}[Spectral trace identity]\label{prop:trace_identity}
  \begin{equation}\label{eq:trace_resolvent_identity}
    F(z)=\Tr(z-\hat H)^{-1}=\sum_{n=0}^\infty \frac{1}{z-E_n},
    \qquad z\notin \{E_n\}.
  \end{equation}
\end{proposition}

\begin{proof}
  Let $\hat H \ket{E_n} = E_n \ket{E_n}$. Therefore, $(z - \hat
  H)\ket{E_n} = (z - E_n)\ket{E_n}$. Therefore, applying $(z -
  H)^{-1}$ on $\ket{E_n}$ gives
  \begin{equation}
    \hat G(z) \ket{E_n} = \frac{1}{z - E_n} \ket{E_n}
  \end{equation}
  Therefore, $\frac{1}{z - E_n}$ is an eigenvalue of $(z - \hat H)^{-1}$. Since
  the trace of matrix is given by the sum of its eigenvalues,
  \begin{equation}
    F(z) = \Tr (z - \hat H)  = \sum _{n} \frac{1}{z - E_n}
  \end{equation}
\end{proof}

\paragraph{Perturbed vs.\ unperturbed traces.}
Let $\hat H=\hat H_0+\lambda \hat V$ with unperturbed eigenpairs
$\{\ket{m},E_m^{(0)}\}$.
Write $\hat G_0(z)=(z-\hat H_0)^{-1}$ and expand the full resolvent
by the Neumann series (Theorem~\ref{eq:neumann_series_resolvent}):

\[
  \hat G(z) = \sum_{n=0}^\infty \lambda^n \hat G_0(z) (\hat V
  \hat G(z)) ^{n}=\hat G_0+\lambda \hat G_0 \hat V \hat G_0+\lambda^2 \hat
  G_0 \hat V \hat G_0 \hat V \hat G_0+\cdots
\]
Taking the trace, we obtain
\begin{equation}\label{eq:F_series_def}
  F(z)=\Tr \left(\sum_{n=0}^\infty \lambda^n \hat G_0(z) (\hat V
  \hat G(z)) ^{n}\right) = \sum_{n=0}^\infty \lambda^n \Tr \left(\hat
    G_0(z) (\hat V
  \hat G(z)) ^{n}\right)
\end{equation}

\subsection{Explicit Index Expansion with Inserted Identities}
Define
\[
  \hat H_0\ket{m}=E_m^{(0)}\ket{m},\qquad
  g_m(z):=\frac{1}{z-E_m^{(0)}},\qquad
  V_{mn}:=\bra{m}\hat V\ket{n}.
\]

We repeatedly insert the identity operator $\hat
I=\sum_k\ket{k}\!\bra{k}$ between every neighboring pair of operators and use
$\bra{a}\hat G_0(z)\ket{b}=g_b(z)\delta_{ab}$ and $\bra{a}\hat
V\ket{b}=V_{ab}$.

\begin{align}
  \Tr\hat G_0
  &=\sum_{r}\bra{r}\hat G_0\hat I\ket{r}
  =\sum_{r}\sum_{m}\bra{r}\hat G_0\ket{m}\bra{m}\ket{r} \notag\\
  &=\sum_{r}\sum_{m} g_m(z)\delta_{rm}\delta_{mr}
  =\sum_{r} g_r(z)
  =\sum_{m_1}\frac{1}{z-E_{m_1}^{(0)}}. \label{eq:F0_explicit}
\end{align}

\begin{align}
  \Tr(\hat G_0\hat V\hat G_0)
  &=\sum_{r}\bra{r}\hat G_0\hat I\hat V\hat I\hat
  G_0\ket{r} \notag\\
  &=\sum_{r}\sum_{a}\sum_{b}\bra{r}\hat G_0\ket{a}\bra{a}\hat
  V\ket{b}\bra{b}\hat G_0\ket{r} \notag\\
  &=\sum_{r,a,b} (g_a\delta_{ra})V_{ab}(g_r\delta_{br})
  =\sum_{r} g_r V_{rr} g_r
  =\sum_{m_1}\frac{V_{m_1m_1}}{(z-E_{m_1}^{(0)})^2}. \label{eq:F1_explicit}
\end{align}

\begin{align}
  \Tr(\hat G_0\hat V\hat G_0\hat V\hat G_0)
  &=\sum_{r}\bra{r}\hat G_0\hat I\hat V\hat I\hat G_0\hat
  I\hat V\hat I\hat G_0\ket{r} \notag\\
  &=\sum_{r}\sum_{a}\sum_{b}\sum_{c}\sum_{d}
  \bra{r}\hat G_0\ket{a}\bra{a}\hat V\ket{b}\bra{b}\hat G_0\ket{c}
  \bra{c}\hat V\ket{d}\bra{d}\hat G_0\ket{r} \notag\\
  &=\sum_{r,a,b,c,d}
  (g_a\delta_{ra})V_{ab}(g_c\delta_{bc})V_{cd}(g_r\delta_{dr})
  \notag\\
  &=\sum_{r,b} g_rV_{rb}g_bV_{br}g_r
  =\sum_{m_1,m_2} g_{m_1}^2g_{m_2}V_{m_1 m_2}V_{m_2 m_1} \notag\\
  &=\sum_{m_1,m_2}
  \frac{V_{m_1 m_2}V_{m_2 m_1}}
  {(z-E_{m_1}^{(0)})^2(z-E_{m_2}^{(0)})}. \label{eq:F2_explicit}
\end{align}

\begin{align}
  \Tr(\hat G_0\hat V\hat G_0\hat V\hat
  G_0\hat V\hat G_0)
  &=\sum_{r}\bra{r}\hat G_0\hat I\hat V\hat I\hat G_0\hat
  I\hat V\hat I\hat G_0\hat I\hat V\hat I\hat
  G_0\ket{r} \notag\\
  &=\sum_{r}\sum_{a,b,c,d,e,f}
  \bra{r}\hat G_0\ket{a}\bra{a}\hat V\ket{b}\bra{b}\hat G_0\ket{c}
  \bra{c}\hat V\ket{d}\bra{d}\hat G_0\ket{e}
  \bra{e}\hat V\ket{f}\bra{f}\hat G_0\ket{r} \notag\\
  &=\sum_{r,a,b,c,d,e,f}
  (g_a\delta_{ra})V_{ab}(g_c\delta_{bc})V_{cd}
  (g_e\delta_{de})V_{ef}(g_r\delta_{fr}) \notag\\
  &=\sum_{r,b,d} g_rV_{rb}g_bV_{bd}g_dV_{dr}g_r \notag\\
  &=\sum_{m_1,m_2,m_3}
  \frac{V_{m_1 m_2}V_{m_2 m_3}V_{m_3 m_1}}
  {(z-E_{m_1}^{(0)})^2(z-E_{m_2}^{(0)})(z-E_{m_3}^{(0)})}.
  \label{eq:F3_explicit}
\end{align}

\begin{align}
  \Tr\!\big(\hat G_0(\hat V\hat G_0)^N\big)
  &=\sum_{r}\bra{r}\hat G_0\hat I\hat V\hat I\hat G_0\hat
  I\cdots\hat V\hat I\hat G_0\ket{r} \notag\\
  &=\sum_{r}\sum_{m_2,\dots,m_{N},m_1}
  \bra{r}\hat G_0\ket{m_1}\bra{m_1}\hat V\ket{m_2}\bra{m_2}\hat G_0\ket{m_3}
  \cdots
  \bra{m_N}\hat V\ket{r}\bra{r}\hat G_0\ket{r} \notag\\
  &=\sum_{r,m_2,\dots,m_N}
  g_rV_{r m_2}g_{m_2}V_{m_2 m_3}\cdots V_{m_N r}g_r \notag\\
  &=\sum_{m_1,\dots,m_N}
  g_{m_1}^2\!\!\prod_{j=2}^{N} g_{m_j}
  \ \prod_{j=1}^{N} V_{m_jm_{j+1}},\qquad m_{N+1}\equiv m_1 \notag\\
  &=\sum_{m_1,\dots,m_N}
  \frac{V_{m_1 m_2}V_{m_2 m_3}\cdots V_{m_N m_1}}
  {(z-E_{m_1}^{(0)})^2(z-E_{m_2}^{(0)})\cdots (z-E_{m_N}^{(0)})}.
  \label{eq:FN_explicit}
\end{align}

\subsection{Extracting energy corrections from residues.}
By Proposition~\ref{prop:trace_identity}, the $F(z)$ is a
meromorphic function with simple poles at the energies
$\{E_n\}$ and unit residues:
\[
  F(z)=\sum_n \frac{1}{z-E_n}.
\]
Fix $n$ and encircle the perturbed eigenvalue with a small contour
$\Gamma_n$ that excludes all other poles.
Then
\begin{align}\label{eq:residue_energy_shift_master}
  \frac{1}{2\pi i}\oint_{\Gamma_n} (z-E_n^{(0)})F(z)dz
  &=\frac{1}{2\pi i} \sum _{i} \oint_{\Gamma_n} \frac{z-E_n^{(0)}}{z-E_i}dz \\
  &=\frac{1}{2\pi i} \oint_{\Gamma_n} \frac{z-E_n^{(0)}}{z-E_n}dz \\
  &=\frac{1}{2\pi i} \oint_{\Gamma_n} \frac{z-E_n + E_n - E_n^{(0)}}{z-E_n}dz \\
  &=\frac{1}{2\pi i} \oint_{\Gamma_n} \left(\cancel{1} + \frac{E_n
  -E_n^{(0)}}{z-E_n}\right)dz \\
  &=\frac{E_n-E_n^{(0)}}{2\pi
  i}\oint_{\Gamma_n}\frac{dz}{z-E_n}\\
  &=E_n-E_n^{(0)} = \Delta E_n,
\end{align}
where $\Delta E_n:=E_n-E_n^{(0)}$. Then, we have $E_n = E_n^{(0)} +
\frac{1}{2\pi i}\oint_{\Gamma_n} (z-E_n^{(0)})F(z)dz$.
Substituting the trace of the Neumann series for the $F(z)$, we get
\begin{align}
  E_n &= E_n^{(0)} + \frac{1}{2\pi i}\oint_{\Gamma_n}
  (z-E_n^{(0)})\sum_{n=0}^\infty \lambda^n \Tr \left(\hat
    G_0(z) (\hat V
  \hat G(z)) ^{n}\right)dz \\
  &=  E_n^{(0)} + \sum _{N=1}^{\infty} \lambda^n \frac{1}{2\pi
  i}\oint_{\Gamma_n}
  (z-E_n^{(0)})
  \sum_{m_1,\dots,m_N}
  \frac{V_{m_1 m_2}V_{m_2 m_3}\cdots V_{m_N m_1}}
  {(z-E_{m_1}^{(0)})^2(z-E_{m_2}^{(0)})\cdots (z-E_{m_N}^{(0)})}dz
\end{align}
\subsection{Energy corrections up to fourth order}
Define $F_N (z)$ such that
\begin{equation}
  F(z)=\Tr\,\hat G(z)=\sum_{N=0}^{\infty}\lambda^N F_N(z),
  \qquad
  F_N(z)=\Tr\big(\hat G_0(\hat V\hat G_0)^N\big),
\end{equation}
We derived the explicit form
\begin{equation}
  \label{eq:FN_loop}
  F_N(z)=\sum_{m_1,\dots,m_N}
  \frac{V_{m_1 m_2}V_{m_2 m_3}\cdots V_{m_N m_1}}
  {(z-E_{m_1}^{(0)})^2\,(z-E_{m_2}^{(0)})\cdots(z-E_{m_N}^{(0)})}.
\end{equation}
As shown earlier,
\begin{equation}
  \label{eq:ResidueRule}
  \Delta E_n^{(N)}=\Res_{z=E_n^{(0)}}\big[(z-E_n^{(0)})F_N(z)\big].
\end{equation}
Write $\Delta_{mn}:=E_n^{(0)}-E_m^{(0)}$ and note $g_m(z)=1/(z-E_m^{(0)})$.

\paragraph{First order.}
\[
  F_1(z)=\sum_{m_1}\frac{V_{m_1m_1}}{(z-E_{m_1}^{(0)})^2}.
\]
Only $m_1=n$ contributes a simple pole to $(z-E_n^{(0)})F_1(z)$:
\[
  (z-E_n^{(0)})F_1(z)=\frac{V_{nn}}{z-E_n^{(0)}}+\bigl[\text{holomorphic at
  }z=E_n^{(0)}\bigr]
\]
Thus
\begin{equation}
  \label{eq:DE1}
  \Delta E_n^{(1)}=V_{nn}.
\end{equation}

\paragraph{Second order.}
\[
  F_2(z)=\sum_{m_1,m_2}\frac{V_{m_1m_2}V_{m_2m_1}}{(z-E_{m_1}^{(0)})^2(z-E_{m_2}^{(0)})}.
\]
Multiply by $(z-E_n^{(0)})$ and analyze cases:

\emph{(i) $m_1=n$, $m_2\neq n$.} Then
\[
  (z-E_n^{(0)})\frac{V_{n m_2}V_{m_2 n}}{(z-E_n^{(0)})^2(z-E_{m_2}^{(0)})}
  =\frac{|V_{m_2n}|^2}{(z-E_n^{(0)})(z-E_{m_2}^{(0)})}
  \ \xrightarrow[\text{Res at
  }z=E_n^{(0)}]{}\ \frac{|V_{m_2n}|^2}{E_n^{(0)}-E_{m_2}^{(0)}}.
\]

\emph{(ii) $m_1=n$, $m_2=n$.} Then we have
$(z-E_n^{(0)})/(z-E_n^{(0)})^3$ which is of order
$(z-E_n^{(0)})^{-2}$ its residue is 0.

No other case yields a pole at $z=E_n^{(0)}$. Hence
\begin{equation}
  \label{eq:DE2}
  \Delta E_n^{(2)}=\sum_{m\neq n}\frac{|V_{mn}|^2}{\Delta_{mn}}.
\end{equation}
\end{document}
